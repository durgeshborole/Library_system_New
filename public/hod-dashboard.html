<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HOD Dashboard - MITCORER</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal inline tweaks for clarity */
    .navbar { display: flex; gap: 1rem; padding: 0.5rem 1rem; background:#f5f5f5; align-items:center; }
    .nav-links { list-style:none; display:flex; gap:0.75rem; margin:0; padding:0; }
    .nav-links a { text-decoration:none; padding:6px 12px; background:#e0e0e0; border-radius:6px; }
    .profile-container { margin-left:auto; position:relative; }
    .profile-dropdown { position:absolute; top:100%; right:0; background:#fff; border:1px solid #ccc; padding:8px; border-radius:6px; display:none; min-width:180px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
    .card { background:#fff; padding:16px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.04); margin-bottom:1rem; }
    .dashboard { max-width:1100px; margin:1rem auto; display:grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap:1rem; }
    .btn { padding:8px 14px; border:none; border-radius:8px; cursor:pointer; background:#2563eb; color:#fff; }
    .small { font-size:0.9rem; color:#555; }
    #stats { display:flex; gap:1rem; flex-wrap:wrap; }
    .stat-box { flex:1; min-width:160px; background:#f0f8ff; padding:12px; border-radius:8px; }
  </style>
</head>

<body>
  <header class="mit-header">
    <img src="./images/mit-corer.jpg" alt="MITCORER Logo" class="mit-logo" style="height:50px;"/>
    <div class="header-text">
      <p class="sub-text">Under the aegis of MAEER's MIT Pune</p>
      <h1 style="margin:4px 0; font-size:1.25rem;">HOD Dashboard</h1>
      <p class="aff-text" style="margin:0;font-size:0.8rem;">
        MIT COLLEGE OF RAILWAY ENGINEERING & RESEARCH, Barshi — <strong>DTE CODE - 06901</strong>
      </p>
    </div>
  </header>

  <nav class="navbar">
    <div class="logo"><strong>HOD</strong></div>
    <ul class="nav-links">
      <li><a href="#" id="homeLink">Home</a></li>
      <li><a href="students.html" id="manageStudents">Manage Students</a></li>
      <li><a href="logs.html" id="viewLogs">Logs</a></li>
      <li><a href="reports.html" id="reports">Reports</a></li>
    </ul>
    <div class="profile-container">
      <button id="loginBtn" class="btn" style="display:none;">Login</button>
      <div id="profileMenu" style="display:none; cursor:pointer;">
        <span id="hodEmail" style="margin-right:8px;"></span>
        <img src="./images/profile-icon.jpg" alt="Profile" style="width:32px; height:32px; border-radius:50%; vertical-align:middle;" id="profileIcon"/>
      </div>
      <div class="profile-dropdown" id="profileDropdown">
        <div class="profile-details small">
          <p id="dropdownEmail" style="margin:4px 0; font-weight:600;"></p>
          <p class="small" style="margin:2px 0;">Role: HOD</p>
        </div>
        <hr/>
        <button class="btn" style="width:100%; margin-bottom:6px;" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <main class="dashboard">
    <div class="card">
      <h3>Welcome, Head of Department</h3>
      <p class="small">Quick summary of today's activity.</p>
      <div id="stats">
        <div class="stat-box">
          <div><strong>Total Visits Today</strong></div>
          <div id="totalVisits">—</div>
        </div>
        <div class="stat-box">
          <div><strong>Currently Inside</strong></div>
          <div id="insideCount">—</div>
        </div>
        <div class="stat-box">
          <div><strong>Peak Hour</strong></div>
          <div id="peakHour">—</div>
        </div>
        <div class="stat-box">
          <div><strong>Most Frequent Dept</strong></div>
          <div id="topDept">—</div>
        </div>
        <div class="stat-box">
          <div><strong>Last Entry</strong></div>
          <div id="lastEntry">—</div>
        </div>
      </div>
      <button class="btn" onclick="refreshStats()" style="margin-top:8px;">Refresh</button>
    </div>

    <div class="card">
      <h3>Student Search / Quick Actions</h3>
      <p class="small">Lookup by barcode or name.</p>
      <input type="text" id="studentSearch" placeholder="Enter name or barcode" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ccc;"/>
      <div style="margin-top:8px;">
        <button class="btn" onclick="searchStudent()">Search</button>
        <button class="btn" style="background:#10b981;" onclick="goToManage()">Manage Students</button>
      </div>
      <div id="searchResult" style="margin-top:12px;"></div>
    </div>

    <div class="card">
      <h3>Live Log Updates</h3>
      <p class="small">Automatically updates when new scan happens.</p>
      <div id="liveIndicator">Connecting...</div>
      <div style="margin-top:8px;">
        <button class="btn" onclick="loadRecentLogs()">View Recent Logs</button>
      </div>
      <div id="recentLogs" style="margin-top:12px; max-height:240px; overflow:auto; font-size:0.9rem;"></div>
    </div>

    <div class="card">
      <h3>Register New Visitor / Student</h3>
      <p class="small">Quick add if missing.</p>
      <button class="btn" onclick="location.href='add-users.html'">Add Student</button>
    </div>
  </main>

  <footer class="footer" style="text-align:center; padding:12px; font-size:0.8rem;">
    <p>HOD Dashboard | Developed by MITCORER Team</p>
  </footer>

  <script>
    let socket;
    const authToken = localStorage.getItem('authToken');
    const hodEmail = localStorage.getItem('hodEmail') || localStorage.getItem('adminEmail');

    function showLoggedIn() {
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenu').style.display = 'inline-flex';
      document.getElementById('hodEmail').textContent = hodEmail || '';
      document.getElementById('dropdownEmail').textContent = hodEmail || '';
    }

    function showLoggedOut() {
      document.getElementById('loginBtn').style.display = 'inline-block';
      document.getElementById('profileMenu').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (authToken && hodEmail) {
        showLoggedIn();
      } else {
        showLoggedOut();
      }

      // Dropdown toggle
      document.getElementById('profileIcon').addEventListener('click', (e) => {
        const dd = document.getElementById('profileDropdown');
        dd.style.display = dd.style.display === 'block' ? 'none' : 'block';
        e.stopPropagation();
      });
      window.addEventListener('click', () => {
        document.getElementById('profileDropdown').style.display = 'none';
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('hodEmail');
        alert('Logged out.');
        location.reload();
      });

      // Initialize socket for live updates
      try {
        socket = io(); // assumes socket.io client script is loaded globally
        socket.on('connect', () => {
          document.getElementById('liveIndicator').textContent = 'Live connected'; 
          socket.on('logUpdate', () => {
            loadRecentLogs();
            refreshStats();
          });
        });
        socket.on('disconnect', () => {
          document.getElementById('liveIndicator').textContent = 'Disconnected';
        });
      } catch (e) {
        document.getElementById('liveIndicator').textContent = 'Socket init failed';
      }

      // Initial load
      refreshStats();
      loadRecentLogs();
    });

    async function refreshStats() {
      try {
        const res = await fetch('/stats');
        const data = await res.json();
        document.getElementById('totalVisits').textContent = data.totalVisitorsToday ?? '—';
        document.getElementById('insideCount').textContent = data.currentlyInside ?? '—';
        document.getElementById('topDept').textContent = data.mostFrequentDept || '—';
        document.getElementById('lastEntry').textContent = data.lastEntry || '—';

        // peak hour derived naive: not provided here, placeholder
        document.getElementById('peakHour').textContent = 'N/A';
      } catch (e) {
        console.error('Stats load failed', e);
      }
    }

    async function loadRecentLogs() {
      try {
        const res = await fetch('/live-log');
        const logs = await res.json();
        const container = document.getElementById('recentLogs');
        container.innerHTML = '';
        if (!Array.isArray(logs) || logs.length === 0) {
          container.textContent = 'No recent logs.';
          return;
        }
        logs.slice(0, 10).forEach(log => {
          const div = document.createElement('div');
          div.style.borderBottom = '1px solid #eee';
          div.style.padding = '6px 0';
          div.innerHTML = `
            <div><strong>${log.name || 'Unknown'}</strong> (${log.designation || ''})</div>
            <div class="small">Dept: ${log.department || '-'} | Entry: ${new Date(log.entryTime).toLocaleTimeString()} | Exit: ${log.exitTime ? new Date(log.exitTime).toLocaleTimeString() : 'Inside'}</div>
          `;
          container.appendChild(div);
        });
      } catch (e) {
        console.error('Recent logs failed', e);
        document.getElementById('recentLogs').textContent = 'Failed to load logs.';
      }
    }

    async function searchStudent() {
      const q = document.getElementById('studentSearch').value.trim();
      if (!q) return alert('Enter name or barcode');
      try {
        const res = await fetch(`/students?search=${encodeURIComponent(q)}&page=1&limit=5`);
        const data = await res.json();
        const box = document.getElementById('searchResult');
        if (!data.students || data.students.length === 0) {
          box.innerHTML = '<div>No matches found.</div>';
          return;
        }
        box.innerHTML = data.students.map(s => {
          return `
            <div style="border:1px solid #ddd; padding:6px; border-radius:6px; margin-bottom:4px;">
              <div><strong>${s.name}</strong> (${s.barcode})</div>
              <div class="small">Dept: ${s.department} | Year: ${s.year}</div>
              <div class="small">Email: ${s.email} | Mobile: ${s.mobile}</div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Search failed', e);
      }
    }

    function goToManage() {
      location.href = 'manage-students.html';
    }
  </script>
  <script src="/socket.io/socket.io.js"></script>
</body>
</html>
